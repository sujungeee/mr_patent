<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°© ëª©ë¡ + SSE ì—°ê²°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chatList { margin-top: 20px; }
        .chat-room {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chat-room .unread {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>ğŸ’¬ ì±„íŒ…ë°© ëª©ë¡ + ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</h2>
<label>ìœ ì € ID: <input type="number" id="userId" placeholder="ex) 1" /></label>
<button onclick="getChatList()">ì¡°íšŒ ë° SSE ì—°ê²°</button>

<div id="chatList"></div>

<script>
    let eventSource = null;

    function getChatList() {
        const userId = document.getElementById("userId").value;
        if (!userId) {
            alert("ìœ ì € IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }

        const chatListDiv = document.getElementById("chatList");
        chatListDiv.innerHTML = "ğŸ“¡ ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        // ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
        fetch(`http://localhost:8080/api/chat/rooms/${userId}`)
            .then(res => res.json())
            .then(data => {
                const chatRooms = data.data;

                if (!chatRooms || chatRooms.length === 0) {
                    chatListDiv.innerHTML = "<p>âŒ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                chatListDiv.innerHTML = "";
                chatRooms.forEach(room => {
                    const div = document.createElement("div");
                    div.className = "chat-room";
                    div.id = `room-${room.roomId}`;

                    div.innerHTML = `
              <p><strong>ì±„íŒ…ë°© ID:</strong> ${room.roomId}</p>
              <p><strong>ë§ˆì§€ë§‰ ë©”ì‹œì§€:</strong> <span class="last-message">${room.lastMessage || "(ì—†ìŒ)"}</span></p>
              <p><strong>ì‹œê°„:</strong> <span class="timestamp">${room.lastTimestamp || "-"}</span></p>
              <p><strong>ì•ˆì½ì€ ë©”ì‹œì§€:</strong> <span class="unread-count">${room.unreadCount}</span>
              ${room.unreadCount > 0 ? '<span class="unread">(ì•ˆì½ìŒ)</span>' : ''}</p>
            `;

                    chatListDiv.appendChild(div);
                });
            });

        // SSE ì—°ê²° ì‹œì‘
        if (eventSource) {
            eventSource.close(); // ê¸°ì¡´ ì—°ê²° ë‹«ê¸°
        }

        eventSource = new EventSource(`http://localhost:8080/api/chat/rooms/subscribe/${userId}`);

        eventSource.onopen = () => {
            console.log("âœ… SSE ì—°ê²° ì™„ë£Œ");
        };

        eventSource.onmessage = (event) => {
            console.log("ğŸ“¨ SSE ë©”ì‹œì§€ ë„ì°©:", event.data);
            const data = JSON.parse(event.data);

            if (data.type === "CHAT_UPDATE") {
                const roomDiv = document.getElementById(`room-${data.roomId}`);
                if (roomDiv) {
                    roomDiv.querySelector(".last-message").textContent = data.lastMessage;
                    roomDiv.querySelector(".timestamp").textContent = data.timestamp;
                    roomDiv.querySelector(".unread-count").textContent = data.unreadCount;

                    if (data.unreadCount > 0) {
                        roomDiv.querySelector(".unread-count").insertAdjacentHTML('afterend', '<span class="unread">(ì•ˆì½ìŒ)</span>');
                    }
                }
            }
        };

        eventSource.onerror = (err) => {
            console.error("âŒ SSE ì—ëŸ¬ ë°œìƒ", err);
        };
    }
</script>

</body>
</html>
