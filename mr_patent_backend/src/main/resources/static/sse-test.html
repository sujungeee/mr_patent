<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°© ëª©ë¡ (SSE í…ŒìŠ¤íŠ¸)</title>
    <style>
        .room {
            border: 1px solid #ccc;
            margin: 5px 0;
            padding: 10px;
        }
        .unread {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>ì±„íŒ…ë°© ëª©ë¡ (SSE ì‹¤ì‹œê°„ ë°˜ì˜)</h2>

<!-- ì‚¬ìš©ì ID ì…ë ¥ -->
<label>ìœ ì € ID: <input type="text" id="userId" value="1" /></label>
<button onclick="loadChatRooms()">ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ + SSE ì—°ê²°</button>

<!-- SSE ì—°ê²° ìƒíƒœ í‘œì‹œ -->
<div id="sseStatus">SSE ìƒíƒœ: â³ ëŒ€ê¸° ì¤‘...</div>

<!-- ì±„íŒ…ë°© ëª©ë¡ -->
<div id="chatList"></div>

<script>
    let eventSource = null;

    function loadChatRooms() {
        const userId = document.getElementById('userId').value;

        // 1. ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        document.getElementById('chatList').innerHTML = '';

        // 2. ê¸°ì¡´ SSE ì—°ê²° ì¢…ë£Œ
        if (eventSource) {
            eventSource.close();
        }

        // 3. ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
        fetch(`/api/chat/rooms/${userId}`)
            .then(response => response.json())
            .then(result => {
                const chatRooms = result.data;
                chatRooms.forEach(room => appendChatRoom(room));
            });

        // 4. SSE ì—°ê²°
        eventSource = new EventSource(`/api/chat/rooms/subscribe/${userId}`);

        eventSource.onopen = () => {
            document.getElementById('sseStatus').innerText = 'SSE ìƒíƒœ: ğŸŸ¢ ì—°ê²°ë¨';
        };

        eventSource.onerror = () => {
            document.getElementById('sseStatus').innerText = 'SSE ìƒíƒœ: ğŸ”´ ì—°ê²° ëŠê¹€';
        };

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("ğŸ“© ë°›ì€ SSE ë°ì´í„°: ", data);

            const roomId = data.roomId;
            let roomDiv = document.getElementById(`room-${roomId}`);

            if (!roomDiv) {
                // ìƒˆë¡œìš´ ì±„íŒ…ë°©
                appendChatRoom(data);
            } else {
                // ê¸°ì¡´ ì±„íŒ…ë°© ì—…ë°ì´íŠ¸
                roomDiv.querySelector('.last-message').innerText = data.lastMessage;
                roomDiv.querySelector('.timestamp').innerText = data.timestamp;
                const unreadElem = roomDiv.querySelector('.unread');
                if (data.unreadCount === 0) {
                    unreadElem.innerText = '';
                } else {
                    unreadElem.innerText = data.unreadCount;
                }
            }
        };
    }

    function appendChatRoom(room) {
        const div = document.createElement('div');
        div.className = 'room';
        div.id = `room-${room.roomId}`;
        div.innerHTML = `
            <b>Room ID:</b> ${room.roomId}<br>
            <span class="last-message">${room.lastMessage}</span><br>
            <span class="timestamp">${room.lastTimestamp || 'ì‹œê°„ ì—†ìŒ'}</span><br>
            <span class="unread">${room.unreadCount > 0 ? room.unreadCount : ''}</span>
        `;
        document.getElementById('chatList').appendChild(div);
    }
</script>

</body>
</html>
