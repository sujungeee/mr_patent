<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>1:1 ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
<div>
    <input type="text" id="roomId" placeholder="ì±„íŒ…ë°© ID ì…ë ¥" />
    <button onclick="changeRoom()">ì±„íŒ…ë°© ì´ë™</button><br>
    <label>User ID: <input type="text" id="userId" value="user1"></label><br>
    <label>Receiver ID: <input type="text" id="receiverId" value="user2"></label><br>
    <label>Message: <input type="text" id="message"></label><br>

    <button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
</div>

<h3>ë©”ì‹œì§€ ë¡œê·¸</h3>
<div id="chatLog" style="border:1px solid #ccc; padding:10px; width:400px; height:200px; overflow:auto;"></div>

<script>
    let stompClient = null;
    let currentSubscription = null;
    function connect() {
        const socket = new WebSocket('ws://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log("âœ… STOMP ì—°ê²° ì„±ê³µ");

            const roomId = document.getElementById('roomId').value;
            subscribeToRoom(roomId);
        });
    }
    function subscribeToRoom(roomId) {
        const userId = document.getElementById('userId').value;

        // ê¸°ì¡´ êµ¬ë…ì´ ìˆë‹¤ë©´ í•´ì œ
        if (currentSubscription !== null) {
            currentSubscription.unsubscribe();
            console.log('ğŸ”„ ì´ì „ êµ¬ë… í•´ì œ');
        }
        currentSubscription = stompClient.subscribe('/sub/chat/room/' + roomId, (message) => {

            const msg = JSON.parse(message.body);
            const log = document.getElementById('chatLog');
            log.innerHTML += `<div><b>${msg.userId}</b>: ${msg.message}</div>`;
        },
            {
                userId: userId,
                roomId: roomId
            }
        );
        console.log('ğŸŸ¢ ìƒˆ ì±„íŒ…ë°© êµ¬ë… ì‹œì‘: /sub/chat/room/' + roomId);
    }

    function changeRoom() {
        const newRoomId = document.getElementById('roomId').value;
        subscribeToRoom(newRoomId); // êµ¬ë… ê²½ë¡œë§Œ ë°”ê¿”ì¤Œ
    }

    function sendMessage() {
        const roomId = document.getElementById('roomId').value;
        const userId = document.getElementById('userId').value;
        const receiverId = document.getElementById('receiverId').value;
        const message = document.getElementById('message').value;

        stompClient.send('/pub/chat/message', {}, JSON.stringify({
            roomId: roomId,
            userId: userId,
            receiverId: receiverId,
            message: message,
            timestamp: null,
            isRead: "N"
        }));
    }
    connect();
</script>
</body>
</html>
